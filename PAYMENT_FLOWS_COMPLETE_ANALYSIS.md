# ğŸ’³ Complete Payment Flows Analysis - Sehat Makaan App

---

## **Overview**

**3 Main Payment Flows** in the app (all use **PayFast** gateway):

1. âœ… **Workshop Registration Payment** (Participant pays to join workshop)
2. âœ… **Workshop Creation Fee Payment** (Doctor pays PKR 10,000 to activate workshop)
3. âœ… **Booking Payment** (Patient pays for doctor appointment booking)

---

## **1ï¸âƒ£ WORKSHOP REGISTRATION PAYMENT**

### **Where It Happens:**
- **File:** `lib/features/workshops/screens/user/workshop_registration_page.dart`
- **Checkout Page:** `lib/features/workshops/screens/user/workshop_checkout_page.dart` âœ… **JUST FIXED**
- **Webhook:** `functions/index.js` â†’ `handlePayFastWebhook` (Line 3335)

### **Complete Flow:**

```
User clicks "Join Workshop"
    â†“
Registration Form Filled
â”œâ”€ First name, Last name
â”œâ”€ Email, CNIC, Phone
â”œâ”€ Institution, Specialty
â””â”€ Notes (optional)
    â†“
"Proceed to Payment" Button
    â†“
Workshop Checkout Page
â”œâ”€ Order Summary (workshop details + price)
â”œâ”€ Terms & Conditions checkbox
â””â”€ "Proceed to Payment" button
    â†“
PayFast Payment Gateway Opens (External)
â”œâ”€ Merchant ID: 14833
â”œâ”€ Merchant Key: rPcy4T7GQkSCFsHBLdn26s
â”œâ”€ Amount: Workshop Price (PKR)
â””â”€ Item: Workshop Title
    â†“
User Completes Payment on PayFast
    â†“
PayFast Sends Webhook Callback âœ… **REAL-TIME LISTENER NOW ADDED**
â”œâ”€ Webhook URL: https://us-central1-sehatmakaan-833e2.cloudfunctions.net/handlePayFastWebhook
â”œâ”€ Payment Status: COMPLETE
â””â”€ Custom Fields: registrationId, paymentId, type=workshop
    â†“
Firestore Updates (Webhook Handler)
â”œâ”€ workshop_registrations.status: 'pending' â†’ 'confirmed' âœ…
â”œâ”€ workshop_payments.status: 'pending' â†’ 'paid'
â”œâ”€ Generates registration number: WS-YYYY-TIMESTAMP
â””â”€ Increments workshop.currentParticipants (prevents overbooking)
    â†“
âœ… Auto-Confirmation on App (Real-time Listener)
â”œâ”€ Dialog closes automatically
â”œâ”€ Success toast shown
â””â”€ Navigation back to workshops page
    â†“
"My Joined Workshops" Section Shows
â”œâ”€ Green "âœ… Confirmed" badge appears
â”œâ”€ Workshop title, price, description
â””â”€ Countdown timer to workshop date
```

### **Key Data Saved:**

**collection: `workshop_registrations`**
```dart
{
  'workshopId': 'workshop_id',
  'userId': 'user_id',
  'firstName': 'John',
  'lastName': 'Doe',
  'email': 'john@example.com',
  'cnic': '12345-1234567-1',
  'phone': '0300-1234567',
  'institution': 'ABC Hospital',
  'specialty': 'Cardiology',
  'notes': 'Optional notes',
  'status': 'confirmed',                    // Updated by webhook
  'paymentStatus': 'paid',                  // Updated by webhook
  'registrationNumber': 'WS-2026-123456',   // Generated by webhook
  'paymentId': 'payfast_payment_id',
  'confirmedAt': Timestamp,                 // Set by webhook
  'registeredAt': Timestamp,
  'updatedAt': Timestamp
}
```

**collection: `workshop_payments`**
```dart
{
  'registrationId': 'registration_id',
  'workshopId': 'workshop_id',
  'userId': 'user_id',
  'amount': 5000,  // PKR
  'status': 'paid',                    // Updated by webhook
  'paymentMethod': 'payfast',
  'paymentId': 'payfast_payment_id',   // Updated by webhook
  'paidAt': Timestamp,                 // Set by webhook
  'createdAt': Timestamp
}
```

### **What's New (FIXED):**
âœ… Real-time listener added to detect payment confirmation
âœ… Auto-closes pending dialog when status changes
âœ… Shows success toast automatically
âœ… Auto-navigates back to workshops page

---

## **2ï¸âƒ£ WORKSHOP CREATION FEE PAYMENT**

### **Where It Happens:**
- **File:** `lib/features/workshops/screens/user/workshop_creation_fee_checkout_page.dart`
- **Route:** `/workshop-creation-fee-checkout`
- **Webhook:** `functions/index.js` â†’ `payfastWorkshopCreationWebhook` (Line 473)

### **Complete Flow:**

```
Doctor Creates Workshop (Form Filled)
    â†“
Submits Workshop for Admin Approval
â”œâ”€ Workshop status: 'pending_admin'
â””â”€ Waits for admin review
    â†“
Admin Approves Workshop âœ…
â”œâ”€ Workshop status: 'approved'
â””â”€ Payment required before going live
    â†“
Doctor Sees "Pay Creation Fee" Button
â”œâ”€ Amount: PKR 10,000 (Fixed)
â””â”€ Must pay before workshop can receive participants
    â†“
"Pay Now" Button Clicked
    â†“
Workshop Creation Fee Checkout Page
â”œâ”€ Workshop details summary (title, type, provider, date, time, price)
â”œâ”€ Max participants
â”œâ”€ "PKR 10,000 - One-time creation fee" highlighted
â””â”€ "Proceed to Payment" button
    â†“
PayFast Payment Gateway Opens
â”œâ”€ Amount: 10000 (Fixed)
â”œâ”€ Item: Workshop Creation Fee - [Workshop Title]
â””â”€ Custom field: type=workshop_creation
    â†“
Doctor Completes Payment
    â†“
PayFast Webhook Sent
â”œâ”€ Status: COMPLETE
â”œâ”€ Custom fields: workshopId, type=workshop_creation
â””â”€ Webhook URL: https://us-central1-sehatmakaan-833e2.cloudfunctions.net/payfastWorkshopCreationWebhook
    â†“
Firestore Updates (Webhook)
â”œâ”€ workshops.isActive: false â†’ true âœ…
â”œâ”€ workshops.status: 'approved' â†’ 'active'
â”œâ”€ workshop_payments: payment marked as 'paid'
â””â”€ Workshop now accepts registrations!
    â†“
Workshop Goes Live
â”œâ”€ Appears in "Discover Workshops" for all users
â”œâ”€ Users can now register and pay
â””â”€ Doctor can manage registrations
```

### **Key Data Saved:**

**collection: `workshop_payments`** (Creation Fee)
```dart
{
  'workshopId': 'workshop_id',
  'creatorId': 'doctor_id',
  'amount': 10000,  // PKR (Fixed)
  'type': 'creation_fee',
  'status': 'paid',                    // Updated by webhook
  'paymentMethod': 'payfast',
  'paymentId': 'payfast_payment_id',   // Updated by webhook
  'paidAt': Timestamp,                 // Set by webhook
  'createdAt': Timestamp
}
```

**collection: `workshops`** (Updated)
```dart
{
  'isActive': true,          // Changed from false by webhook
  'status': 'active',        // Changed from 'approved' by webhook
  'creationFeeStatus': 'paid',
  'creationFeePaidAt': Timestamp,
  'updatedAt': Timestamp
}
```

---

## **3ï¸âƒ£ BOOKING PAYMENT (Doctor Appointment)**

### **Where It Happens:**
- **File:** `lib/features/bookings/screens/user/booking_workflow_page.dart`
- **Payment Step:** `lib/features/payments/screens/payment_step.dart`
- **Webhook:** `functions/index.js` â†’ `payfastWebhook` (Line 352)

### **Complete Flow:**

```
Patient Starts Booking (Suite â†’ Type â†’ Specialty)
    â†“
Date & Time Slot Selection
â”œâ”€ Picks preferred date
â”œâ”€ Selects time slot (hourly: 1-4 hours or specific time)
â””â”€ Priority booking addon (for 6PM+ or weekend slots)
    â†“
Add-ons Selection (Optional)
â”œâ”€ Priority Booking: PKR 5,000
â”œâ”€ Extended Hours: PKR 2,500
â””â”€ Additional services if any
    â†“
Booking Summary Review
â”œâ”€ Base rate (suite specific)
â”œâ”€ Priority multiplier (if applicable)
â”œâ”€ Add-ons total
â”œâ”€ Tax calculation
â””â”€ Total amount (PKR)
    â†“
Payment Step
â”œâ”€ Multiple payment methods available:
â”‚  â”œâ”€ PayFast (Credit Card)
â”‚  â”œâ”€ JazzCash (Mobile Wallet)
â”‚  â”œâ”€ EasyPaisa (Mobile Wallet)
â”‚  â””â”€ Bank Transfer
â”œâ”€ Patient selects PayFast
â””â”€ Terms acceptance
    â†“
PayFast Payment Gateway Opens
â”œâ”€ Amount: Total booking cost (PKR)
â”œâ”€ Item: Doctor Booking - [Specialty]
â””â”€ Custom fields: bookingId, registrationId
    â†“
Patient Completes Payment
    â†“
PayFast Webhook Sent
â”œâ”€ Status: COMPLETE
â””â”€ Webhook URL: https://us-central1-sehatmakaan-833e2.cloudfunctions.net/payfastWebhook
    â†“
Firestore Updates (Webhook)
â”œâ”€ bookings.paymentStatus: 'pending' â†’ 'paid' âœ…
â”œâ”€ bookings.status: 'confirmed'
â”œâ”€ booking_payments.status: 'paid'
â””â”€ Doctor sees booking in calendar
    â†“
Confirmation Email Sent to Patient
â”œâ”€ Booking ID
â”œâ”€ Doctor details
â”œâ”€ Appointment time
â”œâ”€ Cancellation policy
â””â”€ Contact support link
    â†“
Patient Can View Booking
â”œâ”€ In "My Bookings" section
â”œâ”€ Can request cancellation (with refund rules)
â””â”€ Get appointment reminders
```

### **Key Data Saved:**

**collection: `bookings`**
```dart
{
  'userId': 'patient_id',
  'doctorId': 'doctor_id',
  'suiteId': 'suite_id',
  'bookingType': 'hourly',          // or 'monthly_subscription'
  'specialty': 'Cardiology',
  'baseRate': 5000,
  'package': 'standard',             // for monthly
  'totalHours': 2,                   // for hourly
  'startTime': '14:00',
  'endTime': '16:00',
  'addonsTotal': 5000,               // Priority + Extended Hours
  'tax': 0,
  'totalAmount': 10000,
  'selectedAddons': [
    {'name': 'Priority Booking', 'code': 'priority_booking', 'price': 5000},
    {'name': 'Extended Hours', 'code': 'extended_hours', 'price': 2500}
  ],
  'bookingDate': Timestamp,
  'status': 'confirmed',             // Updated by webhook
  'paymentStatus': 'paid',           // Updated by webhook
  'paymentMethod': 'payfast',
  'paymentId': 'payfast_payment_id', // Added by webhook
  'createdAt': Timestamp,
  'confirmedAt': Timestamp
}
```

**collection: `booking_payments`**
```dart
{
  'bookingId': 'booking_id',
  'userId': 'patient_id',
  'amount': 10000,  // PKR
  'status': 'paid',                    // Updated by webhook
  'paymentMethod': 'payfast',
  'paymentId': 'payfast_payment_id',   // Updated by webhook
  'paidAt': Timestamp,                 // Set by webhook
  'payfastData': {...},                // Full PayFast response
  'createdAt': Timestamp
}
```

---

## **PAYMENT GATEWAY DETAILS**

### **PayFast Configuration:**

| Property | Value |
|----------|-------|
| **Merchant ID** | 14833 |
| **Merchant Key** | rPcy4T7GQkSCFsHBLdn26s |
| **Payment URL** | https://www.payfast.co.za/eng/process |
| **Test Mode** | âŒ PRODUCTION (Not test mode) |
| **Currencies** | ZAR, PKR supported |

### **Webhook Endpoints:**

| Payment Type | Webhook Endpoint | Handler Function |
|--------------|-----------------|------------------|
| Workshop Registration | handlePayFastWebhook | Confirms registration, increments participants |
| Workshop Creation Fee | payfastWorkshopCreationWebhook | Activates workshop, makes it live |
| Booking Payment | payfastWebhook | Confirms booking, sends email |

### **Payment Flow Sequence:**

```
App â†’ PayFast Gateway (External)
         â†“
User Pays on PayFast
         â†“
PayFast â†’ Firebase Cloud Function (Webhook)
         â†“
Function Updates Firestore
         â†“
Real-time Listener in App Detects Change âœ… NOW ACTIVE
         â†“
App Shows Success & Auto-Navigates
```

---

## **âš ï¸ IMPORTANT NOTES**

### **1. Real-Time Confirmation (JUST FIXED):**
- **Before:** Users had to manually refresh to see payment confirmation
- **After:** Real-time listener auto-confirms when webhook updates Firestore
- **How:** Listener on registration document watches for `status === 'confirmed'`
- **Result:** Automatic dialog close + success toast + auto-navigation âœ…

### **2. Payment Methods:**
- **Workshops:** Only **PayFast** (Credit card only)
- **Bookings:** Multiple options (PayFast, JazzCash, EasyPaisa, Bank Transfer)
- **Cart:** Not fully implemented yet (CheckoutPage expects CartItem[] but gets nothing)

### **3. Creation Fee:**
- **PKR 10,000** one-time fee per workshop
- Doctor must pay **before workshop goes live**
- Once paid: `workshops.isActive = true` and participants can register

### **4. Addon System:**
- Priority Booking: PKR 5,000 (access to 6PM+ and weekend slots)
- Extended Hours: PKR 2,500 (extend booking hours)
- Addons are optional but required for certain time slots

### **5. Security:**
- âš ï¸ **Merchant credentials hardcoded** in source code (should use environment variables)
- âœ… Webhook verification implemented
- âœ… Transaction safety: Uses Firestore transactions to prevent overbooking

---

## **FLOW SUMMARY TABLE**

| Feature | Payment Type | Amount | Gateway | Status | Auto-Confirm |
|---------|-------------|--------|---------|--------|--------------|
| **Workshop Join** | Participant registration | Workshop price | PayFast | âœ… FIXED | âœ… YES |
| **Workshop Activate** | Creation fee | PKR 10,000 | PayFast | âœ… Working | âœ… YES |
| **Booking** | Appointment payment | Variable | PayFast+ | âœ… Working | âœ… YES |
| **Cart Checkout** | Product purchase | Variable | PayFast | âŒ Broken | âŒ NO |

---

## **Status Summary:**

âœ… **Workshop Payment:** Working with real-time confirmation (just fixed)
âœ… **Workshop Creation Fee:** Working 
âœ… **Booking Payment:** Working
âŒ **Cart Checkout:** Not wired properly (incomplete)

---

Generated: 27-Jan-2026
Last Updated: After payment confirmation fix
